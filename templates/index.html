<!DOCTYPE html>
<html>
<head>
  <script src="https://code.jquery.com/jquery-1.11.3.js"></script>

  <script type="text/javascript" src="{{ url_for('static', filename = 'index.js') }}"></script>


</head>

<body>
<div id="setUser">
  <div class="title">Set user</div>
  <span class="label">Name</span> <input id="uname" type="text" name="uname" />
  <span class="label">UUID</span> <input id="uuid" type="text" name="uuid" />
  <input type="button" value="OK" />
</div>
<div id="setContext">
  <div class="title">Enter context</div>
  <!-- Creating -->
  <span class="label">Title</span> <input id="cname" type="text" name="cname" />
  <span class="label">UUID</span> <input id="cuuid" type="text" name="cuuid" />

  <!-- Should probably be a select list -->
  <span class="label">Theme</span> <input id="ctheme" type="text" name="ctheme" />
</div>
<div id="context">
  <div class="title">Context</div>
  <span id="debug">...</span>
  <div id="toolbar">This is toolbar div</div>
  <div id="board">This is the board div</div>
  <div id="trash">This is the trash div</div>
</div>

<script type="text/javascript">
  // Move this to separate file
  // TODO: this function is not stable, 15 or 16 chars
  //var uniqueId = Math.random().toString(36).substring(2)
  //             + (new Date()).getTime().toString(36).substring(3, 11);
  //$('#uuid').val(uniqueId);

  $.urlParam = function (name) {
      var results = new RegExp('[\?&]' + name + '=([^&#]*)')
                        .exec(window.location.search);
      return (results !== null) ? results[1] || 0 : false;
  }

  function setView(view) {
    views = new Array("setUser", "setContext", "context");

    for(i = 0; i < views.length; i++) {
      v = views[i];
      $("#" + v).hide();
    }

    $("#" + view).show();
    // TODO:
    //
    //
  }

  function setUser(name, key) {
    localStorage.setItem("user.name", name);
    localStorage.setItem("user.key", key);
  }

  function loadAndValidateUser() {
    name = localStorage.getItem("user.name");
    key =  localStorage.getItem("user.key");

    if(name && key && name != "" && key != "")
      return true;

    return false;
  }

  function getUserKey() {
    return localStorage.getItem("user.key");
  }

  function hasContextKey() {
    ctx = $.urlParam('c');
    key = $.urlParam('k');

    return (key != false && ctx != false);
  }


  function loadContext() {
    ctx = $.urlParam('c');
    key = $.urlParam('k');

    $.ajax({
      url: '/retro/node/' + ctx + '?s=' + key,
      dataType: 'json',
      cache: false
    }).done(function(data){
      res = data['result'];
      if(res == 200) {
        // Validate board
        // TODO: are we admin - do we have admins? (MVP)
        $("#debug").text(JSON.stringify(data['json']));

        // TODO: Load the elements
        loadContextChildren();

        setView('context');
      }
      else {
        alert('Something failed - see console for response');
        console.log(data);
      }
    });
  }

  function loadContextChildren() {
    ctx = $.urlParam('c');
    key = $.urlParam('k');
    $.ajax({
      url: '/retro/node/' + ctx + '/children?s=' + key,
      dataType: 'json',
      cache: false
    }).done(function(data){
      res = data['result'];
      if(res == 200) {
        console.log(data);
      }
      else {
        alert('Something failed - see console for response');
        console.log(data);
      }
    });

  }

  // INIT
  if(!loadAndValidateUser()) {
    setView('setUser');
  }
  else {
    if(hasContextKey()) {
      loadContext();
    }
    else {
      setView('setContext');
    }
  }


</script>
</body>
</html>
